<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>配当管理アプリ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Hiragino Sans", "Noto Sans JP", "Yu Gothic", sans-serif;
      background: #f0f2f5; color: #1a1a2e; min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #fff; padding: 1.5rem 2rem;
    }
    header h1 { font-size: 1.5rem; font-weight: 700; }
    .subtitle { font-size: 0.85rem; color: #a0aec0; margin-top: 0.25rem; }
    main { max-width: 960px; margin: 0 auto; padding: 1.5rem 1rem; }

    .summary-cards {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem; margin-bottom: 1.5rem;
    }
    .card.summary {
      background: #fff; border-radius: 12px; padding: 1.2rem 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .card-label { font-size: 0.8rem; color: #718096; margin-bottom: 0.4rem; }
    .card-value { font-size: 1.6rem; font-weight: 700; }

    /* 追加エリア */
    .add-area {
      background: #fff; border-radius: 12px; padding: 1.2rem 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1.5rem;
    }
    .add-area h2 { font-size: 1rem; margin-bottom: 0.8rem; }
    .add-row {
      display: flex; gap: 0.6rem; align-items: flex-end; flex-wrap: wrap;
    }
    .add-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .add-group label { font-size: 0.75rem; color: #718096; font-weight: 600; }
    .add-group input {
      padding: 0.5rem 0.7rem; border: 1px solid #e2e8f0; border-radius: 8px;
      font-size: 0.9rem; outline: none; width: 140px;
    }
    .add-group input:focus { border-color: #2563eb; }
    .btn-primary {
      background: #2563eb; color: #fff; border: none; padding: 0.55rem 1.2rem;
      border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
      white-space: nowrap;
    }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-primary:disabled { background: #a0aec0; cursor: not-allowed; }

    .fetch-status {
      font-size: 0.8rem; margin-top: 0.6rem; padding: 0.4rem 0.6rem;
      border-radius: 6px; display: none;
    }
    .fetch-status.loading { display: block; background: #ebf8ff; color: #2b6cb0; }
    .fetch-status.error { display: block; background: #fed7d7; color: #c53030; }
    .fetch-status.success { display: block; background: #c6f6d5; color: #276749; }

    /* 銘柄リスト */
    .stock-list { display: flex; flex-direction: column; gap: 0.8rem; }
    .empty-msg { text-align: center; color: #a0aec0; padding: 2rem; }

    .stock-card {
      background: #fff; border-radius: 12px; padding: 1rem 1.2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items: start;
      transition: box-shadow 0.2s;
    }
    .stock-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .stock-card.past { opacity: 0.5; }

    .stock-main { display: flex; flex-direction: column; gap: 0.3rem; }
    .stock-header { display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap; }
    .stock-code {
      font-size: 0.75rem; background: #edf2f7; color: #4a5568;
      padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 600;
    }
    .stock-name { font-size: 1rem; font-weight: 700; }
    .stock-type {
      font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: 600;
    }
    .type-中間 { background: #dbeafe; color: #1e40af; }
    .type-期末 { background: #fce7f3; color: #9d174d; }

    .stock-info-row {
      display: flex; gap: 1.2rem; font-size: 0.82rem; color: #4a5568; flex-wrap: wrap;
    }
    .stock-info-row strong { color: #1a1a2e; }
    .info-label { font-size: 0.7rem; color: #a0aec0; }

    .badge {
      display: inline-block; font-size: 0.75rem; font-weight: 700;
      padding: 0.2rem 0.6rem; border-radius: 6px; margin-top: 0.2rem;
    }
    .badge.urgent { background: #fed7d7; color: #c53030; }
    .badge.soon   { background: #fefcbf; color: #975a16; }
    .badge.ok     { background: #c6f6d5; color: #276749; }
    .badge.passed { background: #e2e8f0; color: #a0aec0; }

    .stock-dividend { text-align: right; min-width: 130px; }
    .dividend-amount { font-size: 1.3rem; font-weight: 700; color: #2563eb; }
    .dividend-sub { font-size: 0.75rem; color: #718096; }
    .dividend-sub strong { color: #1a1a2e; }
    .dividend-yield { font-size: 0.75rem; color: #38a169; font-weight: 600; }

    .stock-actions { display: flex; gap: 0.3rem; margin-top: 0.4rem; }
    .stock-actions button {
      background: none; border: 1px solid #e2e8f0; border-radius: 6px;
      padding: 0.25rem 0.6rem; font-size: 0.75rem; color: #718096; cursor: pointer;
    }
    .stock-actions button:hover { background: #f7fafc; color: #1a1a2e; }
    .stock-actions button.delete:hover {
      background: #fed7d7; color: #c53030; border-color: #feb2b2;
    }

    /* 編集モーダル */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      z-index: 100; justify-content: center; align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: #fff; border-radius: 16px; padding: 1.5rem 2rem;
      width: 90%; max-width: 420px; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }
    .modal h2 { font-size: 1.1rem; margin-bottom: 1rem; }
    .form-group { margin-bottom: 0.8rem; }
    .form-group label {
      display: block; font-size: 0.8rem; font-weight: 600;
      color: #4a5568; margin-bottom: 0.3rem;
    }
    .form-group input {
      width: 100%; padding: 0.5rem 0.7rem; border: 1px solid #e2e8f0;
      border-radius: 8px; font-size: 0.9rem; outline: none;
    }
    .form-group input:focus { border-color: #2563eb; }
    .form-actions { display: flex; justify-content: flex-end; gap: 0.6rem; margin-top: 1rem; }
    .btn-secondary {
      background: #e2e8f0; color: #4a5568; border: none; padding: 0.6rem 1.4rem;
      border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
    }

    @media (max-width: 600px) {
      .add-row { flex-direction: column; align-items: stretch; }
      .add-group input { width: 100%; }
      .stock-card { grid-template-columns: 1fr; }
      .stock-dividend { text-align: left; }
    }
  </style>
</head>
<body>
  <header>
    <h1>配当管理</h1>
    <p class="subtitle">銘柄コードを入力するだけ。配当情報を自動取得。</p>
  </header>

  <main>
    <section class="summary-cards">
      <div class="card summary">
        <div class="card-label">登録銘柄数</div>
        <div class="card-value" id="val-total">-</div>
      </div>
      <div class="card summary">
        <div class="card-label">今後の配当予定</div>
        <div class="card-value" id="val-upcoming">-</div>
      </div>
      <div class="card summary">
        <div class="card-label">予想配当合計</div>
        <div class="card-value" id="val-income">-</div>
      </div>
    </section>

    <!-- 銘柄追加 -->
    <section class="add-area">
      <h2>銘柄を追加</h2>
      <div class="add-row">
        <div class="add-group">
          <label>銘柄コード</label>
          <input type="text" id="add-code" placeholder="例: 7203" maxlength="5">
        </div>
        <div class="add-group">
          <label>保有株数</label>
          <input type="number" id="add-shares" placeholder="例: 100" min="0" value="100">
        </div>
        <button class="btn-primary" id="add-btn" onclick="addByCode()">自動取得して追加</button>
      </div>
      <div class="fetch-status" id="fetch-status"></div>
    </section>

    <section class="stock-list" id="stock-list"></section>
  </main>

  <!-- 保有株数の編集モーダル -->
  <div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <h2>保有株数を変更</h2>
      <input type="hidden" id="edit-id">
      <div class="form-group">
        <label>銘柄</label>
        <input type="text" id="edit-label" disabled>
      </div>
      <div class="form-group">
        <label>保有株数</label>
        <input type="number" id="edit-shares" min="0">
      </div>
      <div class="form-actions">
        <button class="btn-secondary" onclick="closeModal()">キャンセル</button>
        <button class="btn-primary" onclick="saveEdit()">保存</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "dividend_stocks_v2";

    // --- Yahoo Finance v8 chart API (認証不要・配当データ付き) ---
    async function fetchWithProxy(url) {
      // 複数のCORSプロキシを試行
      const proxies = [
        u => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u),
        u => "https://corsproxy.io/?" + encodeURIComponent(u),
        u => "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(u),
      ];
      for (const makeProxy of proxies) {
        try {
          const res = await fetch(makeProxy(url), { signal: AbortSignal.timeout(10000) });
          if (!res.ok) continue;
          const text = await res.text();
          if (!text || text.length < 10) continue;
          return JSON.parse(text);
        } catch (e) { /* try next */ }
      }
      // 直接アクセスも試す（同一オリジンの場合やCORS許可されてる場合）
      try {
        const res = await fetch(url, { signal: AbortSignal.timeout(8000) });
        if (res.ok) return await res.json();
      } catch (e) { /* fall through */ }
      throw new Error("API取得に失敗しました。しばらくしてから再試行してください。");
    }

    async function fetchStockInfo(code) {
      const symbol = code + ".T";
      // v8 chart APIで銘柄名+株価+配当履歴を一括取得
      const url = "https://query1.finance.yahoo.com/v8/finance/chart/" + symbol +
                  "?range=2y&interval=3mo&events=div&lang=ja-JP&region=JP";
      const data = await fetchWithProxy(url);

      if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
        throw new Error("銘柄が見つかりません: " + code);
      }

      const result = data.chart.result[0];
      const meta = result.meta;
      const name = meta.longName || meta.shortName || symbol;
      const price = meta.regularMarketPrice || 0;

      // 配当履歴から直近の配当金額を取得
      const events = result.events || {};
      const divEvents = events.dividends || {};
      const divList = Object.values(divEvents).sort((a, b) => b.date - a.date);

      let halfDividend = 0;
      let annualDividend = 0;
      if (divList.length >= 2) {
        // 直近2回の配当を合算 = 年間配当
        annualDividend = divList[0].amount + divList[1].amount;
        halfDividend = divList[0].amount;
      } else if (divList.length === 1) {
        halfDividend = divList[0].amount;
        annualDividend = halfDividend * 2;
      }

      const dividendYield = price > 0 ? annualDividend / price : 0;

      return { name, price, annualDividend, halfDividend, dividendYield, divHistory: divList };
    }

    // 銘柄名だけ取得するフォールバック (Yahoo search API)
    async function fetchStockName(code) {
      const url = "https://query2.finance.yahoo.com/v1/finance/search?q=" + code +
                  "&quotesCount=1&lang=ja-JP&region=JP&newsCount=0";
      try {
        const data = await fetchWithProxy(url);
        if (data.quotes && data.quotes.length > 0) {
          return data.quotes[0].longname || data.quotes[0].shortname || code + ".T";
        }
      } catch (e) { /* ignore */ }
      return null;
    }

    // --- データ管理 ---
    function loadStocks() {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    }

    function saveStocksData(stocks) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(stocks));
    }

    function calcFiscalDates() {
      // 日本株の一般的な権利確定日 (3月決算が大半)
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + 1;

      const dates = [];
      // 期末: 3/31
      const yearEnd = month <= 3 ? year : year + 1;
      dates.push({ type: "期末", record_date: yearEnd + "-03-31" });
      // 中間: 9/30
      const yearMid = month <= 9 ? year : year + 1;
      dates.push({ type: "中間", record_date: yearMid + "-09-30" });

      return dates;
    }

    // --- 権利付最終日 ---
    function calcLastBuyDate(recordDateStr) {
      const d = new Date(recordDateStr + "T00:00:00");
      let back = 0;
      while (back < 2) {
        d.setDate(d.getDate() - 1);
        if (d.getDay() >= 1 && d.getDay() <= 5) back++;
      }
      return d;
    }

    // --- 銘柄追加 ---
    async function addByCode() {
      const codeInput = document.getElementById("add-code");
      const sharesInput = document.getElementById("add-shares");
      const btn = document.getElementById("add-btn");
      const status = document.getElementById("fetch-status");
      const code = codeInput.value.trim();

      if (!code || !/^\d{4,5}$/.test(code)) {
        status.className = "fetch-status error";
        status.textContent = "4〜5桁の銘柄コードを入力してください";
        return;
      }

      // 重複チェック
      const existing = loadStocks();
      if (existing.some(s => s.code === code)) {
        status.className = "fetch-status error";
        status.textContent = code + " は既に登録済みです";
        return;
      }

      btn.disabled = true;
      status.className = "fetch-status loading";
      status.textContent = code + ".T の情報を取得中...";

      try {
        let info;
        try {
          info = await fetchStockInfo(code);
        } catch (chartErr) {
          // chart APIが失敗したら search API で名前だけ取得してフォールバック
          const fallbackName = await fetchStockName(code);
          if (fallbackName) {
            info = { name: fallbackName, price: 0, annualDividend: 0, halfDividend: 0, dividendYield: 0 };
            status.className = "fetch-status loading";
            status.textContent = fallbackName + " を発見。配当データはAPIから取得できなかったため0円で登録します（後で編集可能）";
          } else {
            throw chartErr;
          }
        }

        const shares = parseInt(sharesInput.value) || 0;
        const fiscalDates = calcFiscalDates();

        const newEntries = fiscalDates.map(fd => ({
          id: crypto.randomUUID(),
          code: code,
          name: info.name,
          record_date: fd.record_date,
          dividend_type: fd.type,
          dividend_per_share: info.halfDividend,
          annual_dividend: info.annualDividend,
          dividend_yield: info.dividendYield,
          shares_held: shares,
        }));

        const stocks = loadStocks();
        stocks.push(...newEntries);
        saveStocksData(stocks);

        if (info.annualDividend > 0) {
          status.className = "fetch-status success";
          status.textContent = info.name + "(" + code + ") を追加！ " +
                               "年間配当: " + info.annualDividend.toFixed(1) + "円/株, " +
                               "利回り: " + (info.dividendYield * 100).toFixed(2) + "%";
        } else if (info.name) {
          status.className = "fetch-status success";
        }
        codeInput.value = "";
        render();
      } catch (e) {
        status.className = "fetch-status error";
        status.textContent = "取得に失敗しました: " + (e.message || "銘柄コードを確認してください");
      } finally {
        btn.disabled = false;
      }
    }

    // Enterキーで追加
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("add-code").addEventListener("keydown", e => {
        if (e.key === "Enter") addByCode();
      });
    });

    // --- 描画 ---
    function render() {
      const stocks = loadStocks();
      const today = new Date(); today.setHours(0, 0, 0, 0);

      // サマリー
      document.getElementById("val-total").textContent =
        new Set(stocks.map(s => s.code)).size;
      let upcomingCount = 0;
      let totalIncome = 0;
      stocks.forEach(s => {
        const lb = calcLastBuyDate(s.record_date);
        if (lb >= today) upcomingCount++;
        totalIncome += s.dividend_per_share * (s.shares_held || 0);
      });
      document.getElementById("val-upcoming").textContent = upcomingCount + " 件";
      document.getElementById("val-income").textContent = "\u00a5" + totalIncome.toLocaleString();

      // ソート: 権利確定日順
      stocks.sort((a, b) => a.record_date.localeCompare(b.record_date));

      const container = document.getElementById("stock-list");
      if (stocks.length === 0) {
        container.innerHTML = '<p class="empty-msg">上の入力欄に銘柄コードを入れて「自動取得して追加」を押してください。</p>';
        return;
      }
      container.innerHTML = stocks.map(s => {
        const lastBuy = calcLastBuyDate(s.record_date);
        const diff = Math.ceil((lastBuy - today) / (1000 * 60 * 60 * 24));

        let badgeCls, badgeTxt;
        if (diff < 0)       { badgeCls = "passed"; badgeTxt = "終了"; }
        else if (diff === 0) { badgeCls = "urgent"; badgeTxt = "今日が最終日！"; }
        else if (diff <= 7)  { badgeCls = "urgent"; badgeTxt = "あと " + diff + " 日"; }
        else if (diff <= 30) { badgeCls = "soon";   badgeTxt = "あと " + diff + " 日"; }
        else                 { badgeCls = "ok";     badgeTxt = "あと " + diff + " 日"; }

        const totalDiv = s.dividend_per_share * (s.shares_held || 0);
        const pastCls = diff < 0 ? " past" : "";
        const typeCls = "type-" + esc(s.dividend_type);
        const yieldStr = s.dividend_yield ? (s.dividend_yield * 100).toFixed(2) + "%" : "";

        return `
          <div class="stock-card${pastCls}">
            <div class="stock-main">
              <div class="stock-header">
                <span class="stock-code">${esc(s.code)}</span>
                <span class="stock-name">${esc(s.name)}</span>
                <span class="stock-type ${typeCls}">${esc(s.dividend_type)}</span>
              </div>
              <div class="stock-info-row">
                <div>
                  <div class="info-label">権利付最終日</div>
                  <strong>${fmtDate(lastBuy)}</strong>
                  <span class="badge ${badgeCls}">${badgeTxt}</span>
                </div>
                <div>
                  <div class="info-label">権利確定日</div>
                  <strong>${fmtDate(new Date(s.record_date + "T00:00:00"))}</strong>
                </div>
              </div>
              <div class="stock-actions">
                <button onclick="editShares('${s.id}')">株数変更</button>
                <button class="delete" onclick="deleteStock('${s.id}')">削除</button>
              </div>
            </div>
            <div class="stock-dividend">
              <div class="dividend-amount">&yen;${s.dividend_per_share.toLocaleString()}</div>
              <div class="dividend-sub">1株あたり(予想)</div>
              ${yieldStr ? `<div class="dividend-yield">利回り ${yieldStr}</div>` : ""}
              ${s.shares_held > 0
                ? `<div class="dividend-sub">${s.shares_held}株 &rarr; <strong>&yen;${totalDiv.toLocaleString()}</strong></div>`
                : '<div class="dividend-sub">保有株数未設定</div>'}
            </div>
          </div>`;
      }).join("");
    }

    function fmtDate(d) {
      const days = ["日","月","火","水","木","金","土"];
      return d.getFullYear() + "/" + (d.getMonth()+1) + "/" + d.getDate() + " (" + days[d.getDay()] + ")";
    }

    function esc(s) {
      const d = document.createElement("div");
      d.textContent = String(s);
      return d.innerHTML;
    }

    // --- 編集・削除 ---
    function editShares(id) {
      const stocks = loadStocks();
      const s = stocks.find(x => x.id === id);
      if (!s) return;
      document.getElementById("modal").classList.add("active");
      document.getElementById("edit-id").value = s.id;
      document.getElementById("edit-label").value = s.code + " " + s.name;
      document.getElementById("edit-shares").value = s.shares_held || 0;
    }

    function saveEdit() {
      const id = document.getElementById("edit-id").value;
      const shares = parseInt(document.getElementById("edit-shares").value) || 0;
      let stocks = loadStocks();
      // 同じ銘柄コードの全エントリの株数を更新
      const target = stocks.find(s => s.id === id);
      if (target) {
        stocks = stocks.map(s =>
          s.code === target.code ? { ...s, shares_held: shares } : s
        );
      }
      saveStocksData(stocks);
      closeModal();
      render();
    }

    function closeModal() {
      document.getElementById("modal").classList.remove("active");
    }

    function deleteStock(id) {
      const stocks = loadStocks();
      const target = stocks.find(s => s.id === id);
      if (!target) return;
      if (!confirm(target.name + "(" + target.dividend_type + ") を削除しますか？")) return;
      saveStocksData(stocks.filter(s => s.id !== id));
      render();
    }

    // 起動
    render();
  </script>
</body>
</html>
